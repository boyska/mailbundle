#!/bin/bash
#### Se manda bene, senno' va in uscita

set -eu

outbox=/tmp/outbox/
while getopts 'd:' opt
do
    case "$opt" in
        d)
        outbox=$OPTARG
        ;;
        \?)
        exit 2
        ;;
    esac
done
shift $((OPTIND-1))

mkdir -p "$outbox"
chmod 700 "$outbox"
msg=$(mktemp --tmpdir= outbox.XXXXXXXX)
trap 'rm -f "$msg"' EXIT


# TODO: prima di inviare dovrei controllare se è già stato inviato. Altrimenti non serve.

set +e
tee "$msg" | "$@" 2>&1 | tee -a $MAIL_ENV/msmtp.log
smtpret=$?
set -e
if test $smtpret -eq 0; then
    exit 0
fi
# TODO: gestisci il nuovo nome da dare alle cose, potrebbe confliggere
mv -n "$msg" "$outbox"

echo "Errore nell'invio messaggio; salvato in posta in uscita"
exit $smtpret
