#!/bin/bash

set -eu

outbox="$MAIL_ENV/outbox/"
while getopts 'd:' opt
do
    case "$opt" in
        d)
        outbox=$OPTARG
        ;;
        *)
        echo "Parse error" >&2
        exit 2
        ;;
    esac
done

[[ -n "$TMUX" ]] && tmux renamew -t "$TMUX_PANE" sync

find "$outbox" -type f|
while read fname
do
    test "$(stat -c %s "$fname")" -eq 0 && continue
    if "$@" < "$fname"; then
        #FIXME: In realta' dovrei segnarmelo da qualche parte, sta cosa dei file vuoti fa un po' schifo
        truncate --size 0 "$fname"
    fi
done

