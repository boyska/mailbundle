#!/bin/bash

set -eu

outbox="$MAIL_ENV/outbox/"
while getopts 'd:' opt
do
    case "$opt" in
        d)
        outbox=$OPTARG
        ;;
        *)
        echo "Parse error" >&2
        exit 2
        ;;
    esac
done

if [[ -n "$TMUX" ]]
then
    old_tmux_name="$(tmux lsp -F '#W')"
    tmux rename-window -t "$TMUX_PANE" sync
fi

title() {
[[ -n "$TMUX" ]] && tmux renamew -t "$TMUX_PANE" "$1"
}

title wait

find "$outbox" -maxdepth 1 -type f|
while read -r fname
do
    if [[ "$(stat -c %s "$fname")" -eq 0 ]]
    then
        continue
    fi
    title "sending"
    if "$@" < "$fname"; then
        # making move-only is atomic, which is nice to have
        mv "$fname" "$outbox/sent/"
        # now we can remove
        gzip "$outbox/sent/$(basename "$fname")"
        # truncate --size 0 "$outbox"/sent/*
    fi
    title wait
done

tmux rename-window -t "$TMUX_PANE" "$old_tmux_name"
